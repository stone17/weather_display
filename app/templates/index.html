<!DOCTYPE html>
<html>
<head>
    <title>Weather Display Manager</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pixelated { image-rendering: pixelated; image-rendering: crisp-edges; }
        .preview-container { background-color: #212529; border-radius: 4px; padding: 15px; }
        .preview-label { color: #ccc; font-size: 0.85rem; margin-bottom: 5px; font-weight: 500; }
        .weather-img { max-width: 100%; height: auto; border: 1px solid #444; border-radius: 3px; background-color: white; }
        .form-label { font-size: 0.85rem; margin-bottom: 0.2rem; font-weight: 500; }
        .form-text { font-size: 0.75rem; }
        .card-header { font-weight: 600; background-color: #fff; }
        .cursor-pointer { cursor: pointer; }
        .list-group-item-action:hover { background-color: #f8f9fa; }
    </style>
</head>
<body class="bg-light">
    
    <nav class="navbar navbar-light bg-white border-bottom shadow-sm mb-4">
        <div class="container-fluid px-4">
            <span class="navbar-brand mb-0 h1">üå§Ô∏è&nbsp; Weather Display Manager</span>
            <form action="/trigger_now" method="post" class="d-flex">
                <button type="submit" class="btn btn-primary btn-sm fw-bold">üîÑ Force Update</button>
            </form>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        {% if message %}
        <div class="alert alert-{{ message.type }} alert-dismissible fade show py-2 mb-3">
            {{ message.text }}
            <button type="button" class="btn-close pb-2" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if not mqtt_status %}
        <div class="alert alert-warning py-2 mb-3">‚ö†Ô∏è <strong>MQTT Offline</strong></div>
        {% endif %}

        <div class="row">
            
            <div class="col-lg-4 col-xl-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header py-2">Settings</div>
                    <div class="card-body p-3">
                        <form action="/update_settings" method="post">
                            
                            <h6 class="text-muted border-bottom pb-1 mb-2 small text-uppercase">Display & Hardware</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-12">
                                    <label class="form-label">Hardware Profile</label>
                                    <select class="form-select form-select-sm" name="hardware_profile">
                                        <option value="spectra_e6" {% if config.get('hardware_profile') == 'spectra_e6' %}selected{% endif %}>reTerminal Spectra E6 (800x480)</option>
                                        <option value="waveshare_565" {% if config.get('hardware_profile') == 'waveshare_565' %}selected{% endif %}>Waveshare 5.65" (600x448)</option>
                                        <option value="waveshare_73" {% if config.get('hardware_profile') == 'waveshare_73' %}selected{% endif %}>Waveshare 7.3" (800x480)</option>
                                        <option value="generic" {% if config.get('hardware_profile') == 'generic' %}selected{% endif %}>Generic</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Dithering Method</label>
                                    <select class="form-select form-select-sm" name="dithering_method">
                                        <option value="floyd_steinberg" {% if config.get('dithering_method') == 'floyd_steinberg' %}selected{% endif %}>Floyd-Steinberg</option>
                                        <option value="none" {% if config.get('dithering_method') == 'none' %}selected{% endif %}>None</option>
                                    </select>
                                </div>
                            </div>

                            <h6 class="text-muted border-bottom pb-1 mb-2 mt-3 small text-uppercase">Weather Data</h6>
                            <div class="mb-2">
                                <label class="form-label">Provider</label>
                                <select class="form-select form-select-sm" name="weather_provider">
                                    {% for p in providers %}
                                    <option value="{{ p }}" {% if config.get('weather_provider') == p %}selected{% endif %}>{{ p|upper }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label">Location</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="inputCityName" name="city_name" placeholder="City Name" value="">
                                    <button class="btn btn-outline-primary" type="button" onclick="openCitySearch()">Search</button>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" id="inputLat" name="lat" placeholder="Lat" value="{{ config.get('lat') or config.get('latitude') or '' }}">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" id="inputLon" name="lon" placeholder="Lon" value="{{ config.get('lon') or config.get('longitude') or '' }}">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Output Format</label>
                                <select class="form-select form-select-sm" name="output_format">
                                    <option value="png" {% if config.get('output_format') == 'png' %}selected{% endif %}>PNG (Web Standard)</option>
                                    <option value="bmp8" {% if config.get('output_format') == 'bmp8' %}selected{% endif %}>BMP 8-bit (P Palette) - Recommended for ESP</option>
                                    <option value="bmp24" {% if config.get('output_format') == 'bmp24' %}selected{% endif %}>BMP 24-bit (RGB)</option>
                                </select>
                            </div>

                            <h6 class="text-muted border-bottom pb-1 mb-2 mt-3 small text-uppercase">Connectivity</h6>
                            <div class="mb-2">
                                <label class="form-label">Display Server IP</label>
                                <input type="text" class="form-control form-control-sm" name="server_ip" value="{{ config.get('server_ip', '') }}" placeholder="192.168.x.x">
                            </div>

                            <label class="form-label mt-1">MQTT Broker</label>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control" name="mqtt_broker" placeholder="Broker IP" value="{{ config.get('mqtt_broker', '') }}">
                                <span class="input-group-text">:</span>
                                <input type="number" class="form-control" name="mqtt_port" placeholder="1883" value="{{ config.get('mqtt_port', 1883) }}" style="max-width: 80px;">
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" name="mqtt_user" placeholder="User" value="{{ config.get('mqtt_user', '') }}">
                                </div>
                                <div class="col-6">
                                    <input type="password" class="form-control form-control-sm" name="mqtt_password" placeholder="Pass" value="{{ config.get('mqtt_password', '') }}">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success w-100 fw-bold">Save & Apply</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-xl-9 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center bg-white">
                        <span>Display Preview</span>
                        <small class="text-muted">Updated: {{ last_update }}</small>
                    </div>
                    <div class="card-body preview-container d-flex flex-column justify-content-center">
                        <div class="row g-3">
                            <div class="col-md-6 text-center">
                                <div class="preview-label">Raw (Standard RGB)</div>
                                <a href="/image/source" target="_blank"><img src="/image/source" id="imgSource" class="weather-img shadow-sm" alt="Raw"></a>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="preview-label">Dithered (ePaper)</div>
                                <a href="/image/dithered" target="_blank"><img src="/image/dithered" id="imgDithered" class="weather-img shadow-sm pixelated" alt="Dithered"></a>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-top border-secondary d-flex justify-content-center align-items-center gap-3">
                            <span class="text-white-50 small">Quick Dither Test:</span>
                            <select id="liveDitherMethod" class="form-select form-select-sm w-auto bg-dark text-white border-secondary">
                                <option value="floyd_steinberg">Floyd-Steinberg</option>
                                <option value="none">None (Nearest)</option>
                            </select>
                            <button onclick="updateDither()" class="btn btn-sm btn-info text-white fw-bold">Apply to Preview</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="citySearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select City</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="citySearchResults" class="list-group list-group-flush">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dither Update Logic
        async function updateDither() {
            const method = document.getElementById('liveDitherMethod').value;
            const formData = new FormData();
            formData.append('method', method);
            try {
                const btn = document.querySelector('button[onclick="updateDither()"]');
                const originalText = btn.innerText;
                btn.innerText = "Processing..."; btn.disabled = true;
                const res = await (await fetch('/apply_dither', { method: 'POST', body: formData })).json();
                if (res.success) document.getElementById('imgDithered').src = "/image/dithered?t=" + Date.now();
                else alert("Error: " + res.error);
                btn.innerText = originalText; btn.disabled = false;
            } catch (e) { alert("Network Error"); }
        }

        // City Search Logic
        const modal = new bootstrap.Modal(document.getElementById('citySearchModal'));
        
        async function openCitySearch() {
            const city = document.getElementById('inputCityName').value;
            if(!city) { alert("Please enter a city name first"); return; }
            
            const formData = new FormData();
            formData.append('city_name', city);
            
            const list = document.getElementById('citySearchResults');
            list.innerHTML = '<div class="p-3 text-center text-muted">Searching...</div>';
            modal.show();

            try {
                const res = await (await fetch('/lookup_city', { method: 'POST', body: formData })).json();
                
                if(res.success) {
                    if (res.results.length > 0) {
                        list.innerHTML = '';
                        res.results.forEach(r => {
                            const name = r.name;
                            const country = r.country || '';
                            const region = r.admin1 || '';
                            const desc = [name, region, country].filter(Boolean).join(', ');
                            
                            const item = document.createElement('a');
                            item.className = 'list-group-item list-group-item-action cursor-pointer';
                            item.innerHTML = `<div><strong>${name}</strong> <small class="text-muted">(${country})</small></div><div class="small text-muted">${region}</div>`;
                            item.onclick = () => selectCity(r.latitude, r.longitude);
                            list.appendChild(item);
                        });
                    } else {
                        list.innerHTML = '<div class="p-3 text-center text-muted">No results found for "' + city + '".</div>';
                    }
                } else {
                    // Display the specific error from the backend
                    list.innerHTML = '<div class="p-3 text-center text-danger">Search failed: ' + res.error + '</div>';
                }
            } catch(e) {
                list.innerHTML = '<div class="p-3 text-center text-danger">Frontend Error: ' + e.message + '</div>';
            }
        }

        function selectCity(lat, lon) {
            document.getElementById('inputLat').value = lat;
            document.getElementById('inputLon').value = lon;
            modal.hide();
        }
    </script>
</body>
</html>