{% extends "layout.html" %}

{% block content %}

<div class="row align-items-start">
    
    <div class="col-lg-4 col-xl-4 mb-4">
        <form action="/update_settings" method="post" id="settingsForm">
            <div class="card shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-general" type="button">General</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-weather" type="button">Weather</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-photos" type="button">Photos</button></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade" id="tab-general">{% include 'partials/tab_general.html' %}</div>
                        <div class="tab-pane fade" id="tab-weather">{% include 'partials/tab_weather.html' %}</div>
                        <div class="tab-pane fade" id="tab-photos">{% include 'partials/tab_photos.html' %}</div>
                    </div>
                </div>
            </div>
        </form>
        
        <div id="photoManagerContainer" class="card shadow-sm mt-3 d-none">
            <div class="card-body">
                {% include 'partials/photo_manager.html' %}
            </div>
        </div>
    </div>

    <div class="col-lg-8 col-xl-8 mb-4">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center bg-white">
                <span>Current Display</span>
                <small class="text-muted">Updated: {{ last_update }}</small>
            </div>
            <div class="card-body preview-container d-flex flex-column justify-content-center">
                <div class="row g-3">
                    <div class="col-md-6 text-center">
                        <div class="preview-label">Source (RGB)</div>
                        <a href="/image/source" target="_blank"><img src="/image/source" id="imgSource" class="weather-img shadow-sm" alt="Raw"></a>
                    </div>
                    <div class="col-md-6 text-center">
                        <div class="preview-label">Dithered (E-Ink)</div>
                        <a href="/image/dithered" target="_blank"><img src="/image/dithered" id="imgDithered" class="weather-img shadow-sm pixelated" alt="Dithered"></a>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top border-secondary d-flex justify-content-center align-items-center gap-3">
                    <span class="text-white-50 small">Quick Dither Test:</span>
                    <select id="liveDitherMethod" class="form-select form-select-sm w-auto bg-dark text-white border-secondary">
                        <option value="floyd_steinberg">Floyd-Steinberg</option>
                        <option value="none">None (Nearest)</option>
                    </select>
                    <button type="button" onclick="updateDither()" class="btn btn-sm btn-info text-white fw-bold">Apply to Preview</button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm" id="graphEditorCard">
            <div class="card-body">
                {% include 'partials/graph_settings.html' %}
            </div>
        </div>

    </div>

</div>

{% endblock %}

{% block modals %}
<div class="modal fade" id="citySearchModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Select City</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div id="citySearchResults" class="list-group list-group-flush"></div></div></div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let saveTimeout;
    const form = document.getElementById('settingsForm');
    const statusBadge = document.getElementById('globalStatus');

    // --- AUTO-SAVE LOGIC ---
    function triggerAutoSave() {
        if(statusBadge) {
            statusBadge.className = "badge bg-warning ms-3"; 
            statusBadge.innerText = "Saving...";
            statusBadge.classList.remove('d-none');
        }

        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            const formData = new FormData(form);
            const graphCard = document.getElementById('graphEditorCard');
            if(graphCard) {
                const inputs = graphCard.querySelectorAll('input, select, textarea');
                inputs.forEach(el => {
                    if (el.name && !el.disabled) {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            if (el.checked) formData.append(el.name, el.value);
                        } else {
                            formData.append(el.name, el.value);
                        }
                    }
                });
            }

            try {
                const response = await fetch('/update_settings', {
                    method: 'POST', body: formData, headers: { 'X-Auto-Save': 'true' }
                });
                if (response.ok) {
                    if(statusBadge) {
                        statusBadge.className = "badge bg-success ms-3"; 
                        statusBadge.innerText = "Saved";
                        setTimeout(() => statusBadge.classList.add('d-none'), 2000);
                    }
                } else {
                    if(statusBadge) { statusBadge.className = "badge bg-danger ms-3"; statusBadge.innerText = "Error"; }
                }
            } catch (e) { 
                console.error("Save failed", e); 
                if(statusBadge) { statusBadge.className = "badge bg-danger ms-3"; statusBadge.innerText = "Network Error"; } 
            }
        }, 800); 
    }

    // --- DYNAMIC API KEY VISIBILITY ---
    function updateApiVisibility() {
        const provider = document.getElementById('weatherProviderSelect').value;
        document.querySelectorAll('.apikey-group').forEach(el => el.style.display = 'none');
        if(provider === 'openweathermap' || provider === 'owm') {
            const el = document.getElementById('apikey_owm'); if(el) el.style.display = 'block';
        } else if(provider === 'meteomatics') {
            const el = document.getElementById('apikey_meteomatics'); if(el) el.style.display = 'block';
        } else if(provider === 'smhi') {
            const el = document.getElementById('apikey_smhi'); if(el) el.style.display = 'block';
        }
    }

    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(el => {
        el.addEventListener('input', triggerAutoSave);
        el.addEventListener('change', triggerAutoSave);
    });
    const providerSelect = document.getElementById('weatherProviderSelect');
    if(providerSelect) providerSelect.addEventListener('change', updateApiVisibility);

    document.addEventListener("DOMContentLoaded", function() {
        updateApiVisibility();
        const tabKey = "weatherDisplay_activeTab";
        const savedTab = sessionStorage.getItem(tabKey) || '#tab-general';
        const triggerEl = document.querySelector(`button[data-bs-target="${savedTab}"]`);
        if (triggerEl) { const tabInstance = new bootstrap.Tab(triggerEl); tabInstance.show(); }
        togglePhotoManager(savedTab);
        const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach(el => {
            el.addEventListener('shown.bs.tab', event => {
                const activeId = event.target.getAttribute('data-bs-target');
                sessionStorage.setItem(tabKey, activeId);
                togglePhotoManager(activeId);
            });
        });
    });

    function togglePhotoManager(targetId) {
        const pm = document.getElementById('photoManagerContainer');
        if(!pm) return;
        if (targetId === '#tab-photos') pm.classList.remove('d-none');
        else pm.classList.add('d-none');
    }

    async function updateDither() {
        const method = document.getElementById('liveDitherMethod').value;
        const formData = new FormData();
        formData.append('method', method);
        try {
            const btn = document.querySelector('button[onclick="updateDither()"]');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; btn.disabled = true;
            const res = await (await fetch('/apply_dither', { method: 'POST', body: formData })).json();
            if (res.success) document.getElementById('imgDithered').src = "/image/dithered?t=" + Date.now();
            else alert("Error: " + res.error);
            btn.innerText = originalText; btn.disabled = false;
        } catch (e) { alert("Network Error"); }
    }

    const modal = new bootstrap.Modal(document.getElementById('citySearchModal'));
    async function openCitySearch() {
        const city = document.getElementById('inputCityName').value;
        if(!city) { alert("Enter city name"); return; }
        const fd = new FormData(); fd.append('city_name', city);
        const list = document.getElementById('citySearchResults');
        list.innerHTML = '<div class="p-3 text-center">Searching...</div>';
        modal.show();
        try {
            const r = await fetch('/lookup_city', { method: 'POST', body: fd });
            if (!r.ok) {
                const text = await r.text();
                list.innerHTML = `<div class="p-3 text-center text-danger">Server Error (${r.status}): ${text}</div>`;
                return;
            }
            const res = await r.json();
            if(res.success && res.results.length) {
                list.innerHTML = '';
                res.results.forEach(x => {
                    const i = document.createElement('a');
                    i.className = 'list-group-item list-group-item-action cursor-pointer';
                    i.innerHTML = `<strong>${x.name}</strong>, ${x.country || ''} <small class="text-muted">${x.admin1 || ''}</small>`;
                    i.onclick = () => { 
                        // Update inputs using new IDs
                        document.getElementById('inputLatitude').value = x.latitude; 
                        document.getElementById('inputLongitude').value = x.longitude; 
                        modal.hide();
                        triggerAutoSave(); 
                    };
                    list.appendChild(i);
                });
            } else list.innerHTML = '<div class="p-3 text-center text-muted">No results found.</div>';
        } catch(e) { list.innerHTML = '<div class="p-3 text-center text-danger">Error: ' + e.message + '</div>'; }
    }
</script>
{% endblock %}